trigger: none
pr: none

name: $(TeamProject)_$(Build.DefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

# Create a daily midnight build for release builds on dev to ensure our release builds function
schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build
  branches:
    include:
    - dev

variables:
  - group: Middleware
  - name: BuildPlatform
    value: 'any cpu'
  - name: BuildConfiguration
    value: 'release'

jobs:
- job: build
  pool:
    name: MwWilson1EsHostedPool
    demands:
    - msbuild
    - DotNetFramework
    - visualstudio
  timeoutInMinutes: 360

  steps:
  - task: UseDotNet@2
    displayName: 'Use .NET Core sdk 2.1.818'
    inputs:
      version: 2.1.818
      installationPath: 'c:\Program Files\dotnet'

  - task: UseDotNet@2
    displayName: 'Use .NET Core sdk 2.1.x'
    inputs:
      version: 2.1.x
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: UseDotNet@2
    displayName: 'Use .Net Core SDK 6'
    inputs:
      version: 6.0.x

  - task: UseDotNet@2
    displayName: 'Use .Net Core SDK 8'
    inputs:
      includePreviewVersions: true
      version: 8.0.x
    condition: eq(variables['TargetNet8'], 'True')

  - task: DotNetCoreCLI@2
    displayName: 'dotnet --list-sdks '
    inputs:
      command: custom
      custom: '--list-sdks '

  - task: CmdLine@1
    displayName: 'Run VerifyResourceUsage.pl'
    inputs:
      filename: perl
      arguments: '$(Agent.BuildDirectory)\s\src\VerifyResourceUsage.pl'

  - powershell: |
      regedit /s .\build\strongNameBypass.reg
      regedit /s .\build\strongNameBypass2.reg
    displayName: 'Strong Name Bypass'

  - task: PowerShell@2
    displayName: 'Update Assembly Info'
    inputs:
      targetType: filePath
      filePath: ./updateAssemblyInfo.ps1
      arguments: '-packageType $(BuildConfiguration)'

  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      command: 'custom'
      projects: 'wilson.sln'
      custom: 'msbuild'
      arguments: '/r:True /p:Configuration=$(BuildConfiguration) /p:Platform="Any CPU" /verbosity:m /p:SourceLinkCreate=true'

  - task: PowerShell@2
    displayName: 'Run Tests'
    inputs:
      targetType: filePath
      filePath: ./runTests.ps1
      arguments: '-buildType $(BuildConfiguration)'

  - task: CopyFiles@2
    displayName: 'Copy Files to: [staging]\ProductBinaries'
    inputs:
      SourceFolder: src
      Contents: |
        **\bin\$(BuildConfiguration)\**\Microsoft.IdentityModel.*.dll
        **\bin\$(BuildConfiguration)\**\Microsoft.IdentityModel.*.pdb
        **\bin\$(BuildConfiguration)\**\System.IdentityModel.Tokens.Jwt.dll
        **\bin\$(BuildConfiguration)\**\System.IdentityModel.Tokens.Jwt.pdb
      TargetFolder: '$(Build.ArtifactStagingDirectory)\ProductBinaries'

  - task: PoliCheck@2
    inputs:
      targetType: 'F'
      optionsFC: '0'
      optionsXS: '0'
      targetArgument: '$(Build.SourcesDirectory)'

  - task: CredScan@3
    inputs:
      suppressionsFile: 'build/credscan-exclusion.json'

  - task: RoslynAnalyzers@2
    inputs:
      userProvideBuildInfo: 'auto'

  - task: BinSkim@4
    inputs:
      InputType: 'Basic'
      Function: 'analyze'
      TargetPattern: 'guardianGlob'
      AnalyzeTargetGlob: '$(Build.ArtifactStagingDirectory)/**.dll;$(Build.ArtifactStagingDirectory)/**.exe;'
      AnalyzeSymPath: '$(Build.ArtifactStagingDirectory)/ProductBinaries'
      AnalyzeHashes: true

  #- task: ServicesDevOpsCopyReports@7

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-publishsecurityanalysislogs.PublishSecurityAnalysisLogs@2
    displayName: 'Publish Security Analysis Logs'
    continueOnError: true

  - task: PostAnalysis@2
    inputs:
      GdnBreakAllTools: false
      GdnBreakGdnToolBinSkim: true
      GdnBreakGdnToolCredScan: true
      GdnBreakGdnToolPoliCheck: true
      GdnBreakGdnToolRoslynAnalyzers: true

  #Sign Wilson 7x task group
  - template: template-sign-wilson-7x.yaml

  - task: PowerShell@2
    displayName: Pack
    inputs:
      targetType: filePath
      filePath: ./pack.ps1
      arguments: '-buildType $(BuildConfiguration) C:\hostedtoolcache\windows\dotnet'

  - task: EsrpCodeSigning@4
    inputs:
      ConnectedServiceName: 'IDDP Code Signing'
      FolderPath: 'artifacts'
      Pattern: '*.nupkg'
      signConfigType: 'inlineSignParams'
      inlineOperation: |
        [
            {
                "keyCode": "CP-401405",
                "operationSetCode": "NuGetSign",
                "parameters": [ ],
                "toolName": "sign",
                "toolVersion": "1.0"
            },
            {
                "keyCode": "CP-401405",
                "operationSetCode": "NuGetVerify",
                "parameters": [ ],
                "toolName": "sign",
                "toolVersion": "1.0"
            }
        ]
      SessionTimeout: '60'
      MaxConcurrency: '50'
      MaxRetryAttempts: '5'
      PendingAnalysisWaitTimeoutMinutes: '5'

  - task: ComponentGovernanceComponentDetection@0
    inputs:
      scanType: 'Register'
      verbosity: 'Verbose'
      alertWarningLevel: 'High'

  - task: PublishSymbols@2
    displayName: 'Publish symbols on symweb (cross publish)'
    inputs:
      SearchPattern: '**\bin\**\*.IdentityModel.*'
      SymbolServerType: TeamServices
      TreatNotIndexedAsWarning: true

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-uploadtotsa.TSAUpload@1
    displayName: 'TSA upload to Codebase: WILSON Stamp: Azure'
    inputs:
      tsaVersion: TsaV2
      codeBaseName: WILSON
      uploadAPIScan: false
      uploadFortifySCA: false
      uploadFxCop: false
      uploadModernCop: false
      uploadPREfast: false
      uploadTSLint: false

  - task: ManifestGeneratorTask@0
    inputs:
      BuildDropPath: '$(Build.SourcesDirectory)\src'
      ManifestDirPath: '$(Build.SourcesDirectory)\artifacts'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish NuGet Package Artifact'
    inputs:
      PathtoPublish: '$(Build.SourcesDirectory)\artifacts'
      ArtifactName: '$(Build.BuildNumber)-nuget-package'

  - task: PostBuildCleanup@3
